<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>LiveChat Widget</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, push, onChildAdded, ref } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, "messages");

    // åˆ›å»ºæ‚¬æµ®æŒ‰é’®
    const button = document.createElement("div");
    button.id = "chat-btn";
    button.innerHTML = "ğŸ’¬";
    Object.assign(button.style, {
      position: "fixed",
      bottom: "20px",
      right: "20px",
      background: "#007bff",
      color: "white",
      borderRadius: "50%",
      width: "60px",
      height: "60px",
      display: "flex",
      justifyContent: "center",
      alignItems: "center",
      fontSize: "30px",
      cursor: "pointer",
      boxShadow: "0 4px 10px rgba(0,0,0,0.3)",
      zIndex: "9999",
    });

    // èŠå¤©çª—å£
    const chatBox = document.createElement("div");
    chatBox.id = "chatbox";
    chatBox.innerHTML = `
      <style>
        #chatbox {
          position: fixed;
          bottom: 90px;
          right: 20px;
          width: 300px;
          background: white;
          border: 1px solid #ccc;
          border-radius: 10px;
          display: none;
          flex-direction: column;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          overflow: hidden;
          z-index: 9998;
        }
        #chatlog {
          height: 250px;
          overflow-y: auto;
          padding: 10px;
          font-family: sans-serif;
          font-size: 14px;
        }
        #chatinput {
          display: flex;
          border-top: 1px solid #ddd;
        }
        #chatinput input {
          flex: 1;
          border: none;
          padding: 10px;
          outline: none;
        }
        #chatinput button {
          border: none;
          background: #007bff;
          color: white;
          padding: 10px 15px;
          cursor: pointer;
        }
      </style>
      <div id="chatlog"></div>
      <div id="chatinput">
        <input id="msg" placeholder="è¾“å…¥æ¶ˆæ¯..." />
        <button id="send">å‘é€</button>
      </div>
    `;
    document.body.appendChild(button);
    document.body.appendChild(chatBox);

    // åˆ‡æ¢æ˜¾ç¤º
    button.onclick = () => {
      chatBox.style.display = chatBox.style.display === "none" ? "flex" : "none";
    };

    const log = chatBox.querySelector("#chatlog");
    const msgInput = chatBox.querySelector("#msg");
    const sendBtn = chatBox.querySelector("#send");

    const userId = "user_" + Math.random().toString(36).substr(2, 6);

    sendBtn.onclick = () => {
      const text = msgInput.value.trim();
      if (!text) return;
      push(chatRef, { from: userId, role: "user", text, time: Date.now() });
      msgInput.value = "";
    };

    onChildAdded(chatRef, (snapshot) => {
      const msg = snapshot.val();
      const div = document.createElement("div");
      div.textContent = `${msg.role === "user" ? "ğŸ‘¤" : "ğŸ’¼"} ${msg.text}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    });
  </script>
</head>
<body></body>
</html>
